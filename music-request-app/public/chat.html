<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Music Request App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Music Request Chat</h1>
    <div id="chat-box"></div>

    <!-- Input untuk memasukkan nama -->
    <input type="text" id="username" placeholder="Masukkan Nama" />
    <input type="text" id="song-request" placeholder="Masukkan Request !req artist - title" />
    <button id="send-btn">Kirim</button>

    <!-- Tombol untuk skip lagu -->
    <input type="password" id="skip-pin" placeholder="Masukkan PIN untuk skip lagu" />
    <button id="skip-btn">Next</button>

    <!-- Pemutar musik menggunakan YouTube IFrame API -->
    <div id="player"></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://warungsteam.vercel.app/socket.io/socket.io.js"></script> <!-- Ganti dengan URL yang sesuai -->
    <script>
        const socket = io();
        let player;
        let queue = [];
        let currentSong = null;

        // Buat YouTube Player
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '0',
                width: '0',
                videoId: '',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            if (queue.length > 0) {
                player.loadVideoById(queue[0].videoId);
            }
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED && queue.length > 0) {
                queue.shift();
                if (queue.length > 0) {
                    player.loadVideoById(queue[0].videoId);
                }
            }
        }

        document.getElementById('send-btn').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const songRequest = document.getElementById('song-request').value;

            if (username && songRequest.startsWith('!req')) {
                const requestData = parseRequest(songRequest, username);
                socket.emit('song request', requestData);
            }
        });

        function parseRequest(request, username) {
            const parts = request.split('!req ')[1].split(' - ');
            return {
                title: parts[1],
                artist: parts[0],
                username: username,
                videoId: ''
            };
        }

        socket.on('song added', (song) => {
            queue.push(song);
            displayRequest(song);
            if (!currentSong) {
                player.loadVideoById(song.videoId);
                currentSong = song;
            }
        });

        function displayRequest(song) {
            const chatBox = document.getElementById('chat-box');
            const requestText = document.createElement('div');
            requestText.textContent = `${song.artist} - ${song.title} - requested by "${song.username}"`;
            chatBox.prepend(requestText);
        }

        document.getElementById('skip-btn').addEventListener('click', () => {
            const pin = document.getElementById('skip-pin').value;
            if (pin === '1234') {
                socket.emit('skip song');
            } else {
                alert('PIN salah. Tidak bisa skip lagu.');
            }
        });

        socket.on('queue updated', (newQueue) => {
            queue = newQueue;
            if (queue.length > 0) {
                player.loadVideoById(queue[0].videoId);
            }
        });
    </script>
</body>
</html>
